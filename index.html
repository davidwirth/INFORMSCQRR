<!DOCTYPE html>
<html>
  <head>
    <style type="text/css">
      @import url('css/jquery.mobile-1.4.2.min.css');
      @import url('css/jquery.mobile.theme-1.4.2.min.css');
      @import url('css/style.css');
    </style>
    <script src="phonegap.js"></script>
    <script src="barcodescanner.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/jquery.mobile-1.4.2.min.js"></script>
    <script type="text/javascript">
      
      var fields = {'event': [ 'item_id', 'description' ], 'entitlement': ['item_id', 'cust_id'] };
      var db = openDatabase( 'event_entitlement', '', 'Event Item Entitlement Database', 2 * 1024 * 1024 );
      // create the database tables if they do not already exist
      db.transaction(function ( tx ) {
        tx.executeSql('CREATE TABLE IF NOT EXISTS event( item_id, description )');
        tx.executeSql('CREATE TABLE IF NOT EXISTS entitlement( item_id, cust_id )');
        tx.executeSql('TRUNCATE entitlement'); // for testing purposes, clearing the table each page load            
      });
      // check if there is data
      db.transaction(function( tx ) {
        tx.executeSql('SELECT * FROM event', [], function( tx, result ) {
          if (result.rows.length == 0) fullDownload();
        },
        function( tx, err ) {
          alert( 'data check failed' + err );
        });
      });
      function fullDownload() {
        $.getJSON( "https://rest.informs.org/event_entitlement_json.php?callback=", function( json ) {
          localStorage.stamp = json.stamp;
          db.transaction( function(tx) {
            $.each( json.tx_data, function( i ) {
              switch( json.tx_data[i][0] ) {
                case '1':
                  var sql = "INSERT INTO " + json.tx_data[i][1] + " VALUES ( '" + json.tx_data[i][2][0] + "','" + json.tx_data[i][2][1] + "' );";
                  break;
                case '2':
                  var sql = "DELETE FROM " + json.tx_data[i][1] + " WHERE " + fields[json.tx_data[i][1]][0] + "='" + json.tx_data[i][2][0] + "' AND ";
                  sql += fields[json.tx_data[i][1]][1] + "='" + json.tx_data[i][2][1] + "';";
              }
              tx.executeSql( sql );
            });
          });
        });
      }
      function scan() {
        var scanner = cordova.require("cordova/plugin/BarcodeScanner");
        scanner.scan(
          function (result) {
            alert( results.text );
            var id = result.text;
            var event_item = 'NETWORK_LUNCHEON';
            db.transaction(function( tx ) {
              tx.executeSql('SELECT cust_id FROM entitlement WHERE item_id='+event_item,[],function(tx, results) {
                if (results.rows.length > 0) alert('yes');
                else alert('no');
              },null);
            });
          }, 
          function (error) {
            alert("Scanning failed: " + error);
          }
        );
      }
      $(document).ready( function() {
        
      });
    </script>
  </head>
  <body>
    <div data-role="page" id="main_page">
      <div data-role="header">
        INFORMS Event QR Scanner
      </div><button onclick="scan()">Network Luncheon</button>
      <h1>Event: </h1>
      <div id="event_items"></div>
      <div data-role="footer" data-position="fixed">
        INFORMS
      </div>
    </div><!-- page -->
    <div data-role="page">
      <div data-role="header" id="result_page">
        INFORMS Event QR Scanner
      </div>
      <h1>Scan Result</h1>
       
      <div id="scan_result"></div>
      <div data-role="footer" data-position="fixed">
        INFORMS
      </div>
    </div><!-- page -->
  </body>
</html>
